(()=>{var jt=Object.defineProperty;var Mt=(i,t,e)=>t in i?jt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var h=(i,t,e)=>(Mt(i,typeof t!="symbol"?t+"":t,e),e);var I={_inherit:function(i){i._getEvents=this._getEvents,i.on=this.on,i.once=this.once,i.removeListener=this.removeListener,i.emit=this.emit},_getEvents:function(){var i=this.events;return i||(this.events=i={})},on:function(i,t){var e=this,s=e._getEvents()[i];return s||(s=e.events[i]=[]),s.push(t),this},once:function(i,t){var e=this;e.on(i,function s(){if(e.removeListener(i,s))return t.apply(this,arguments)})},removeListener:function(i,t){var e=this,s=e._getEvents()[i];if(s){var n=s.indexOf(t);if(n>=0)return s.splice(n,1),!0}return!1},emit:function(){var i=this,t=arguments[0],e=Array.prototype.slice.call(arguments,1),s=this._getEvents()[t];s&&s.forEach(n=>{n.apply(i,e)})}};Array.prototype.forEach||(Array.prototype.forEach=function(i,t){var e,s;if(this===null)throw new TypeError("this is null or not defined");var n=Object(this),l=n.length>>>0;if({}.toString.call(i)!="[object Function]")throw new TypeError(i+" is not a function");for(t&&(e=t),s=0;s<l;){var f;s in n&&(f=n[s],i.call(e,f,s,n)),s++}});Array.prototype.remove=function(i){var t=this.indexOf(i);return t>=0?this.splice(t,1):null};Array.prototype.insertBefore=function(i,t){var e=this.indexOf(t);if(e<0)throw"insertBefore: before not found";this.splice(e,0,i)};Array.prototype.insertAfter=function(i,t){var e=this.indexOf(t);if(e<0)throw"insertAfter: after not found";this.splice(e+1,0,i)};Array.prototype.sample=function(){return this[Math.floor(this.length*Math.random())]};Array.prototype.max=function(){return Math.max.apply(Math,array)};Array.prototype.min=function(){return Math.min.apply(Math,array)};Array.prototype.maxF=function(i){return this.reduce((t,e)=>t===void 0||i(t,e)<0?e:t,void 0)};Array.prototype.minF=function(i){return this.reduce((t,e)=>t===void 0||i(t,e)>0?e:t,void 0)};Array.prototype.contains=function(i){return this.indexOf(i)!==-1};Array.prototype.compact=function(){return this.filter(i=>i!=null)};Object.prototype.merge=function(i,t){for(var e in t)t.hasOwnProperty(e)&&(i[e]=t[e])};Object.values=function(i){var t=[];for(var e in i)i.hasOwnProperty(e)&&t.push(i[e]);return t};Object.keys=function(i){var t=[];for(var e in i)i.hasOwnProperty(e)&&t.push(e);return t};Boolean.prototype.toNumber=function(){return this?1:0};Math.rnd=function(){return(Math.random()-.5)*2};Math.clamp=function(i,t,e){return Math.max(t,Math.min(e,i))};Math.sign=function(i){return i===0?0:i<0?-1:1};Math.easeInOutCubic=function(i){return i/=1/2,i<1?1/2*i*i*i:(i-=2,1/2*(i*i*i+2))};Math.easeOutQuad=function(i){return-1*i*(i-2)};var q={};I._inherit(q);(function(){var i=!1;function t(){i||(i=!0,q.emit("load"))}if(document.addEventListener&&document.addEventListener("DOMContentLoaded",t,!1),/KHTML|WebKit|iCab/i.test(navigator.userAgent))var e=setInterval(()=>{/loaded|complete/i.test(document.readyState)&&(t(),clearInterval(e))},10);window.onload=t})();var H=q;var R=class{constructor(t){this.root=null,this._nextProp=Symbol("_next"+t)}push(t){if(this._nextProp in t)throw typeof t+" "+t.constructor+" already in list "+this._nextProp;t[this._nextProp]=this.root,this.root=t}pop(){if(!(this._nextProp in t))throw typeof t+" "+t.constructor+" not in list "+this._nextProp;let t=this.root;return this.root=t[this._nextProp],t}each(t){let e=this.root;if(!e)return;let s=null,n;for(;e;){n=e[this._nextProp];let l=t(e,R.BREAK,R.DELETE);if(l===R.DELETE){s?s[this._nextProp]=n:this.root=n,delete e[this._nextProp],e=n;continue}else if(l===R.BREAK)break;s=e,e=n}}*iterate(){let t=this.root;if(!t)return;let e=null,s;for(;t;)s=t[this._nextProp],yield t,e=t,t=s}[Symbol.iterator](){return this.iterate()}contains(t){let e=!1;return this.each((s,n)=>{if(s===t)return e=!0,n}),e}},B=R;h(B,"BREAK",Symbol("BREAK")),h(B,"DELETE",Symbol("DELETE"));var K=B;"use strict";var L=class{constructor(t){this.root=null,this.tail=null,this._nextProp=Symbol("_next"+t),this._prevProp=Symbol("_prev"+t),this.listeners={added:[],removed:[]}}get first(){return this.root}push(t){if(this._nextProp in t)throw typeof t+" "+t.constructor+" already in list "+this._nextProp;let e=this.root;e&&(e[this._prevProp]=t),t[this._nextProp]=e,t[this._prevProp]=null,this.root=t,this.tail||(this.tail=t),this.each(function(s){if(s[this._nextProp]===s)throw"koek"});for(let s of this.listeners.added)s(t)}pop(){this.remove(this.root)}remove(t){if(!(this._nextProp in t))throw typeof t+" "+t.constructor+" not in list "+this._nextProp;let e=t[this._prevProp],s=t[this._nextProp];this.root===t?this.root=s:e[this._nextProp]=s,s&&(this.tail=e,s[this._prevProp]=e),delete t[this._nextProp],delete t[this._prevProp];for(let n of this.listeners.removed)n(t)}each(t){let e=this.root;if(!e)return;let s;for(;e;){s=e[this._nextProp];let n=t.call(this,e,L.BREAK,L.DELETE);if(n===L.DELETE){this.remove(e),e=s;continue}else{if(n===L.BREAK)break;e=s}}}*iterate(){let t=this.root;if(!t)return;let e;for(;t;)e=t[this._nextProp],yield t,t=e}[Symbol.iterator](){return this.iterate()}eachReverse(t){let e=this.tail;if(!e)return;let s;for(;e;){s=e[this._prevProp];let n=t(e,L.BREAK,L.DELETE);if(n===L.DELETE){this.remove(e),e=s;continue}else{if(n===L.BREAK)break;e=s}}}insertBefore(t,e){let s=t&&t[this._prevProp],n=t;e[this._nextProp]=n,e[this._prevProp]=s,n&&(n[this._prevProp]=e),s?s[this._nextProp]=e:this.root=e;for(let l of this.listeners.added)l(e)}},F=L;h(F,"DELETE",Symbol("DELETE")),h(F,"BREAK",Symbol("BREAK"));var N=F;function Y(){var i=this;this.lists={},this.objects=new N("object"),this.named={},this.pendingAdd=new K("pendingAdd"),this.pendingRemove=new K("pendingRemove")}var A=Y.prototype;A.add=function(i){this.pendingAdd.push(i)};A.createIndexList=function(i){var t=new N(i);return t.property=i,t};A.remove=function(i){this.pendingRemove.contains(i)||this.pendingRemove.push(i)};A.clear=function(i){var t=this;t.handlePending();for(let e of t.objects)t.remove(e);t.handlePending()};A.handlePending=function(){var i=this;i.pendingAdd.root,i.pendingAdd.each((t,e,s)=>{console.assert(!t._objectmanager),t._objectmanager=i,i.objects.push(t);for(var n in i.lists)(t[i.lists[n].property]||t.constructor[i.lists[n].property])&&i.lists[n].push(t);if(t.name){if(i.named[t.name])throw"Another object with the same name was already added.";i.named[t.name]=t}return s}),i.pendingRemove.each((t,e,s)=>{delete t.__pendingRemove,console.assert(t._objectmanager===i),t._objectmanager=null,i.objects.remove(t);for(var n in i.lists)(t[i.lists[n].property]||t.constructor[i.lists[n].property])&&i.lists[n].remove(t);return t.name&&delete i.named[t.name],s})};var Q=Y;function U(i){this.context=i}var p=U.prototype;p.resizeCanvas=function(){this.context.canvas.width=window.innerWidth,this.context.canvas.height=window.innerHeight};p.clear=function(){this.save(),this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,9e3,9e3),this.restore()};p.fillStyle=function(i){if(i)this.context.fillStyle=i;else return i};p.strokeStyle=function(i){if(i)this.context.strokeStyle=i;else return i};p.font=function(i){this.context.font=i};p.circle=function(i,t,e){this.context.beginPath(),this.context.arc(i,t,e,0,Math.PI*2,!0),this.context.closePath()};p.rectangle=function(i,t,e,s){this.context.rect(i,t,e,s)};p.polygon=function(i){if(this.context.beginPath(),i.length>0){this.context.moveTo(i[0].x,i[0].y);for(var t=1;t<i.length;t++)this.context.lineTo(i[t].x,i[t].y)}this.context.closePath()};p.strokePolygon=function(i){this.polygon(i),this.context.stroke()};p.fillPolygon=function(i){this.polygon(i),this.context.fill()};p.strokeRectangle=function(i,t,e,s){this.context.strokeRect(i,t,e,s)};p.fillRectangle=function(i,t,e,s){this.context.fillRect(i,t,e,s)};p.strokeCircle=function(i,t,e){this.circle(i,t,e),this.context.stroke()};p.fillCircle=function(i,t,e){this.circle(i,t,e),this.context.fill()};p.fillLoading=function(i,t,e,s){var n=this.context,l=(s*360-90)*(Math.PI/180),f=(0-90)*(Math.PI/180);n.beginPath(),n.moveTo(i,t),n.lineTo(i+Math.cos(l)*e,t+Math.sin(l)*e),n.arc(i,t,e,l,f,!1),n.lineTo(i,t),n.closePath(),n.fill()};p.shadow=function(i,t,e,s,n){this.context.shadowColor=i,this.context.shadowBlur=t,this.context.shadowOffsetX=e,this.context.shadowOffsetY=s,n(),this.context.shadowColor="",this.context.shadowBlur=0,this.context.shadowOffsetX=0,this.context.shadowOffsetY=0};p.line=function(i,t,e,s){this.context.beginPath(),this.context.moveTo(i,t),this.context.lineTo(e,s),this.context.closePath()};p.strokeLine=function(i,t,e,s){this.line(i,t,e,s),this.context.stroke()};p.translate=function(i,t,e){this.save(),this.context.translate(i,t),e(),this.restore()};p.rotate=function(i,t,e,s){this.save(),this.context.translate(i,t),this.context.rotate(e),this.context.translate(-i,-t),s(),this.restore()};p.scale=function(i,t,e,s,n){this.save(),this.context.translate(i,t),this.context.scale(e,s),this.context.translate(-i,-t),n(),this.restore()};p.scalerotate=function(i,t,e,s,n,l){this.save(),this.context.translate(i,t),this.context.rotate(n),this.context.scale(e,s),this.context.translate(-i,-t),l(),this.restore()};p.drawImage=function(i,t,e,s,n,l,f,d,x){i&&this.context.drawImage.apply(this.context,arguments)};p.drawCenteredImage=function(i,t,e){i&&this.context.drawImage(i,t-i.width/2,e-i.height/2)};p.fillCenteredText=function(i,t,e){var s=this.context.measureText(i);this.context.fillText(i,t-s.width/2,e)};p.fillText=function(i,t,e){this.context.fillText(i,t,e)};p.save=function(){this._depth||(this._depth=0),this._depth++,this.context.save()};p.restore=function(){if(this._depth<=0)throw console.log("NOES"),"NOES";this.context.restore(),this._depth--};var Z=U;function J(i,t){function e(s,n){if(s<i.length){var l=i[s],f=[function(){return e(s+1,arguments)}];return Array.prototype.unshift.apply(f,n),l.apply(null,f)}else return t.apply(null,n)}return function(){e(0,arguments)}}function X(i,t,e){var s=this;this.objects=new Q,this.objects.lists.update=this.objects.createIndexList("updatable"),this.objects.lists.draw=this.objects.createIndexList("drawable"),this.chains={draw:[],update:[]},this.chains.draw.push(this.chains.draw.objects=function(f,d){for(let x of s.objects.lists.draw)x.draw(f);d(f)}),this.chains.update.push(this.chains.update.objects=function(d,x){for(let u of s.objects.lists.update)u.update(d);s.objects.handlePending(),x(d)}),this.canvas=t,this.graphics=new Z(t.getContext("2d")),this.time=0;var n=0;e.forEach(f=>{var d=f(s,l);d!==l&&l()});function l(){n++,n===e.length&&setTimeout(i,0)}this.components=e}var V=X.prototype;I._inherit(V);Object.defineProperty(V,"width",{get:function(){return this.canvas.width}});Object.defineProperty(V,"height",{get:function(){return this.canvas.height}});V.start=function(){if(this.isRunning)throw"Already started";var i=this,t={};i.time=0,i.running=t,this.canvas.setAttribute("tabIndex","0"),this.canvas.focus(),this.canvas.oncontextmenu=function(){return!1};var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(l){window.setTimeout(l,1e3/60)},s=new Date().getTime();e(n);function n(){var l=new Date().getTime(),f=(l-s)/1e3;s=l,f=1/60,J(i.chains.update,d=>{})(f),i.time+=f,i.canvas.width=i.canvas.parentElement.clientWidth,i.canvas.height=i.canvas.parentElement.clientHeight,i.graphics.clear(),J(i.chains.draw,d=>{})(i.graphics),i.running===t&&e(n)}};V.stop=function(){delete this.running};var tt=X;var _=class{constructor(t,e){this.x=t,this.y=e}set(t,e){return this.x=t,this.y=e,this}add(t,e){return this.x+=t,this.y+=e,this}substract(t,e){return this.x-=t,this.y-=e,this}multiply(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t,this.y/=t,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}length2(){return this.x*this.x+this.y*this.y}distanceTo(t,e){var s=this.x-t;s*=s;var n=this.y-e;return n*=n,Math.sqrt(s+n)}normalize(){var t=this.length();if(t===0)throw"Normalizing 0!";return this.x/=t,this.y/=t,this}normalizeOr(t,e){var s=this.length();return s===0?(this.x=t,this.y=e,this):(this.x/=s,this.y/=s,this)}normalizeOrZero(){return this.normalizeOr(0,0)}dot(t,e){return this.x*t+this.y*e}negate(){return this.x=-this.x,this.y=-this.y,this}normalRight(){var t=this.x;return this.x=-this.y,this.y=t,this}normalLeft(){var t=this.x;return this.x=this.y,this.y=-t,this}equals(t,e){return this.x===t&&this.y===e}toString(){return"Vector("+this.x+","+this.y+")"}rotate(t){var e=this.length(),s=Math.atan2(this.y,this.x)+t;return this.x=Math.cos(s)*e,this.y=Math.sin(s)*e,this}angleToward(t,e){var s=Math.atan2(this.y,this.x),n=Math.atan2(e,t);return s<-Math.PI/2&&n>Math.PI/2&&(s+=Math.PI*2),n<-Math.PI/2&&s>Math.PI/2&&(n+=Math.PI*2),n-s}angle(){return Math.atan2(this.y,this.x)}clone(){return new _(this.x,this.y)}setV(t){return this.set(t.x,t.y)}addV(t){return this.add(t.x,t.y)}substractV(t){return this.substract(t.x,t.y)}multiplyV(t){return this.multiply(t.x,t.y)}divideV(t){return this.divide(t.x,t.y)}normalizeOrV(t){return this.normalizeOr(t.x,t.y)}dotV(t){return this.dot(t.x,t.y)}equalsV(t){return this.equals(t.x,t.y)}distanceToV(t){return this.distanceTo(t.x,t.y)}angleTowardV(t){return this.angleToward(t.x,t.y)}static distance(t,e,s,n){var l=t-s;l*=l;var f=e-n;return f*=f,Math.sqrt(l+f)}},C=_;h(C,"zero",new _(0,0)),h(C,"xaxis",new _(1,0)),h(C,"yaxis",new _(0,1));var g=C;function et(i){return i.state=null,i.changeState=function(t){this.state&&this.state.disable(),this.state=t,this.state&&this.state.enable()},{create:function(t){}}}var it=class{constructor({game:t}){h(this,"level",null);this.game=t}changeLevel(t){if(this.level){for(let e of this.objects.objects)this.game.objects.remove(e);this.level.disable&&this.level.disable()}if(this.game.objects.handlePending(),this.game.emit("levelunloaded"),this.level=t,this.level){for(let e of this.level.objects)this.game.objects.add(e);this.level.enable&&this.level.enable()}this.game.objects.handlePending(),this.game.emit("levelchanged")}restartLevel(){this.game.changeLevel(this.level.clone())}hasNextLevel(t){let e=t||this.level;return e&&e.nextLevel}nextLevel(t){let e=(t||this.level).nextLevel();this.changeLevel(e)}},st=it;var ot=class extends g{constructor({game:t}){super(0,0);h(this,"over",!1);h(this,"buttons",{});this.game=t,this.mouseup=this.mouseup.bind(this),this.mousedown=this.mousedown.bind(this),this.mousemove=this.mousemove.bind(this),this.mousewheel=this.mousewheel.bind(this),this.DOMMouseScroll=this.DOMMouseScroll.bind(this),this.game.canvas.addEventListener("pointerup",this.mouseup,!0),this.game.canvas.addEventListener("pointerdown",this.mousedown,!0),this.game.canvas.addEventListener("pointermove",this.mousemove,!0),this.game.canvas.addEventListener("mousewheel",this.mousewheel,!0),this.game.canvas.addEventListener("DOMMouseScroll",this.DOMMouseScroll,!0)}getMousePosition(t){let e=this.game.canvas.getBoundingClientRect();return new g(t.pageX-e.x,t.pageY-e.y)}mouseup(t){return this.game.mouse.buttons[t.button]&&(this.setV(this.getMousePosition(t)),delete this.buttons[t.button],this.game.emit("mouseup",t.button,this.x,this.y)),!1}mousedown(t){return this.buttons[t.button]||(this.setV(this.getMousePosition(t)),this.buttons[t.button]=!0,this.game.emit("mousedown",t.button,this.x,this.y)),!1}mousemove(t){this.setV(this.getMousePosition(t)),this.game.emit("mousemove",this.x,this.y)}mousewheel(t){this.setV(this.getMousePosition(t)),this.game.emit("mousewheel",t.deltaY,this.x,this.y)}DOMMouseScroll(t){this.setV(this.getMousePosition(t)),this.game.emit("mousewheel",-t.detail)}},nt=ot;function rt(i){i.objects.lists.collide=i.objects.createIndexList("collide"),i.objects.lists.collidable=i.objects.createIndexList("collidable"),i.on("postupdate",()=>{i.emit("precollision"),t(),i.emit("postcollision")});function t(){var e=new g(0,0),s=new g(0,0),n=[];for(let u of i.objects.lists.collidable)n=n.concat(u.collisionlines);for(let u of i.objects.lists.collide){if(!u.velocity)return;u.surfaces=[];for(var l=0;l<5;l++){let v=function(S){for(var j=0;j<S.length;j++){var y=S[j];if(!(y.normal.dotV(u.velocity)>0)){e.setV(y.normal),e.normalRight();var T=y.start.distanceToV(y.end);s.setV(u.position),s.substractV(y.start);var P=y.normal.dotV(s)-u.collisionRadius,k=e.dotV(s);if(!(P<-u.collisionRadius*2))if(P<0){var M;k>0&&k<T?(P*=-1,f.push({lineSegment:y,offset:P})):k<0&&k>-u.collisionRadius?(M=u.position.distanceToV(y.start),M<u.collisionRadius&&(e.setV(u.position),e.substractV(y.start),e.normalize(),f.push({lineSegment:y,offset:u.collisionRadius-M}))):k>T&&k<T+u.collisionRadius&&(M=u.position.distanceToV(y.end),M<u.collisionRadius&&(e.setV(u.position),e.substractV(y.end),e.normalize(),f.push({lineSegment:y,offset:u.collisionRadius-M})))}else continue}}};var f=[];if(v(n),f.length>0){f.sort((S,j)=>j.offset-S.offset);var d=f[0];u.position.add(d.lineSegment.normal.x*d.offset,d.lineSegment.normal.y*d.offset);var x=u.velocity.dotV(d.lineSegment.normal);u.velocity.substract(d.lineSegment.normal.x*x,d.lineSegment.normal.y*x),u.surfaces.push(d),u.collide(d)}else{u.surface=null;break}}}}}var z={27:"escape",32:"space",38:"up",40:"down",39:"right",37:"left",13:"enter",16:"shift",219:"[",221:"]"},E;for(E=0;E<27;E++)z[E+65]=String.fromCharCode(E+97);for(E=0;E<10;E++)z[E+48]=String.fromCharCode(E+48);function at(i){i.keys={},i.canvas.addEventListener("keyup",t=>{var e=z[t.keyCode];e&&(i.keys[e]&&(delete i.keys[e],i.emit("keyup",e)),t.preventDefault())},!0),i.canvas.addEventListener("keydown",t=>{var e=z[t.keyCode];e&&(i.keys[e]||(i.keys[e]=!0,i.emit("keydown",e)),t.preventDefault())},!0)}function ht(){return(Math.random()-.5)*2}function lt(i){function t(e,s){t.step=s/e,t.magnitude=s}i.chains.draw.unshift((e,s)=>{e.save(),e.context.translate(ht()*t.magnitude,ht()*t.magnitude),s(e),e.restore()}),i.chains.update.unshift((e,s)=>{t.magnitude>0&&(t.magnitude-=t.step*e,t.magnitude<0&&(t.magnitude=0)),s(e)}),i.quake=t}function Lt(i,t){for(var e in t)i[e]=t[e]}function ct(i){var t={ready:0,total:0,errors:0};Lt(t,I);var e={status:t,images:{},audio:{},loadImage:s,loadAudio:n};function s(d,x){var u=this,v=document.getElementById("image_"+d);return v?(u.images[d]=v,x(null,v)):(v=new Image,v.src="assets/"+d+".png",v.onload=function(){u.images[d]=v,x(null,v)},v.onerror=function(){x("Could not load image "+d)},v)}function n(d,x){var u=this,v=!1,S=10,j=0,y=document.getElementById("audio_"+d);if(y)return u.audio[d]=y,x(null,y);y=new Audio("assets/"+d+".wav");try{y.addEventListener("canplaythrough",P,!1)}catch(k){console.error(k)}function T(){if(!v){if(j>5e3)return x("Could not load audio "+d);y.readyState?P():(j+=S,setTimeout(T,S))}}function P(){y.removeEventListener("canplaythrough",P),v=!0,u.audio[d]=y,x(null,y)}T()}var l=!1,f=null;return Et(e,i,d=>{d&&console.error(d),l=!0,f&&f()}),function(d,x){if(d.resources=e,!l)return f=x,x}}function Et(i,t,e){var s=this,n=i.status;function l(x,u){!t[x]||t[x].forEach(v=>{n.total++,u.call(i,v,f)})}l("images",i.loadImage),l("audio",i.loadAudio);function f(x){x?(n.errors++,n.emit("changed"),d()):(n.ready++,n.emit("changed"),d())}function d(){n.total<=n.ready+n.errors&&(n.errors>0?e("Not all resources were loaded"):e())}}var dt=class{constructor({game:t,debug:e}){this.game=t,this.update=this.update.bind(this),this.draw=this.draw.bind(this),t.objects.lists.touchable=t.objects.createIndexList("touchable"),t.chains.update.insertBefore(this.update,t.chains.update.objects),e&&t.chains.draw.push(this.draw)}update(t,e){e(t);for(let s of this.game.objects.lists.touchable){for(let n of this.game.objects.lists.touchable)this.detectTouch(s,n);if(s.touching.size)for(let n of s.touching)this.detectTouch(s,n)}}detectTouch(t,e){if(t!==e){var s=t._objectmanager&&e._objectmanager&&t.position.distanceToV(e.position)<=t.touchRadius+e.touchRadius;this.handleTouch(t,e,s),this.handleTouch(e,t,s)}}handleTouch(t,e,s){t.touching||(t.touching=new Set);var n=t.touching.has(e);s!==n&&(s?(t.touching.add(e),t.touch&&t.touch(e)):(t.touching.delete(e),t.untouch&&t.untouch(e)))}draw(t,e){e(t);for(let s of this.game.objects.lists.touchable)t.strokeStyle("red"),t.strokeCircle(s.position.x,s.position.y,s.touchRadius)}},ut=dt;var mt=class extends g{constructor({game:t}){super(0,0);h(this,"zoom",1);h(this,"worldWidth",2048);this.game=t,this.draw=this.draw.bind(this),this.game.chains.draw.camera=this.draw,this.game.chains.draw.insertBefore(this.draw,this.game.chains.draw.objects)}screenToWorld(t,e){var s=this.getPixelsPerMeter();e.x=(t.x-this.game.width*.5)/s+this.game.camera.x,e.y=(t.y-this.game.height*.5)/s+this.game.camera.y}getPixelsPerMeter(){let t=this.worldWidth;return this.game.width/t/this.game.camera.zoom}reset(){this.x=0,this.y=0}draw(t,e){var s=this.getPixelsPerMeter();t.fillStyle("white"),t.fillRectangle(0,0,this.game.width,this.game.height),t.save(),t.context.scale(s,s),t.context.lineWidth/=s,t.context.translate(this.game.width/s*.5,this.game.height/s*.5),t.context.translate(this.x,-this.y),e(t),t.restore()}},ft=mt;var pt=class{constructor({game:t}){this.game=t,this.reload=this.reload.bind(this),this.mousemove=this.mousemove.bind(this),this.keydown=this.keydown.bind(this),this.draw=this.draw.bind(this)}enable(){this.timeout=setTimeout(this.reload,3e3),this.game.once("keydown",this.keydown),this.game.once("mousemove",this.mousemove),this.game.chains.draw.unshift(this.draw)}reload(){document.location.reload(!0)}keydown(){this.disable()}mousemove(){this.disable()}draw(t,e){e(t),t.fillStyle("#ff0000"),t.fillCircle(this.game.width,0,30),t.fillStyle("black")}disable(){clearTimeout(this.timeout),game.chains.draw.remove(this.draw)}},vt=pt;"use strict";var xt=class{constructor({game:t,items:e,gameplayState:s}){h(this,"items",[]);h(this,"item",null);h(this,"leveldef",[]);this.game=t,this.items=e,this.item=e[0],this.gameplayState=s,this.draw=this.draw.bind(this),this.mousedown=this.mousedown.bind(this),this.keydown=this.keydown.bind(this),this.update=this.update.bind(this)}enable(){console.log("enable editor"),this.game.chains.draw.push(this.draw),this.game.on("mousedown",this.mousedown),this.game.on("keydown",this.keydown),this.game.chains.update.push(this.update),this.game.chains.update.remove(this.game.chains.update.camera),this.game.chains.update.remove(this.game.chains.update.objects)}disable(){console.log("disable editor"),this.game.chains.draw.remove(this.draw),this.game.removeListener("mousedown",this.mousedown),this.game.removeListener("keydown",this.keydown),this.game.chains.update.remove(this.update),this.game.chains.update.push(this.game.chains.update.camera),this.game.chains.update.push(this.game.chains.update.objects)}update(t,e){let s=new g((this.game.keys.right?1:0)-(this.game.keys.left?1:0),(this.game.keys.up?1:0)-(this.game.keys.down?1:0));this.game.camera.x+=s.x*t*10,this.game.camera.y+=s.y*t*10,this.game.objects.handlePending(),e(t)}createLevel(){return{name:"level",objects:this.leveldef.map(([t,e,s])=>new t({x:e,y:s})),clone:this.createLevel.bind(this),nextLevel:this.createLevel.bind(this)}}getPosition(){var t=new g;return this.game.camera.screenToWorld(this.game.mouse,t),t.x=Math.round(t.x),t.y=Math.round(t.y),t}place(){var t=this.getPosition();this.leveldef.push([this.item,t.x,t.y]),this.game.objects.add(new this.item({x:t.x,y:t.y}))}deleteItem(){var t=this.getPosition();this.getCell(t.x,t.y).forEach(s=>s.destroy()),this.leveldef=this.leveldef.filter(([,s,n])=>s!==t.x||n!==t.y)}load(){this.leveldef=[];for(let t of this.game.objects.lists.export)this.leveldef.push([t.constructor,t.position.x,t.position.y])}save(){let t=this.leveldef.map(([e,s,n])=>`new ${e.name}({ x: ${s}, y: ${n}}),`).join(`
`);t+=`
new Start({ x: 0, y: 0 })`,window.navigator.clipboard.writeText(t).then(()=>{console.log("level copied to clipboard")})}mousedown(t){t===0?this.place():t===2&&this.deleteItem()}keydown(t){t==="p"?this.save():t==="i"?this.load():t==="e"?this.game.changeState(this.gameplayState):t==="r"&&this.game.changeLevel(this.createLevel());var e=(t==="]"?1:0)-(t==="["?1:0);this.item=this.items[(this.items.indexOf(this.item)+e+this.items.length)%this.items.length]}draw(t,e){e(t);for(let f of this.game.objects.lists.editorVisible)f.drawForeground(t);let s=new g;this.game.camera.screenToWorld(g.zero,s);let n=new g;this.game.camera.screenToWorld(new g(this.game.width,this.game.height),n),s.x=Math.floor(s.x),s.y=Math.floor(s.y),n.x=Math.ceil(n.x),n.y=Math.ceil(n.y),t.context.globalAlpha=.1,t.strokeStyle("black"),t.context.globalAlpha=1;var l=this.getPosition();t.fillStyle("black"),t.fillCircle(l.x,l.y,.1),this.item&&(t.context.globalAlpha=.5,this.item.prototype.drawForeground.call({position:{x:l.x,y:l.y},velocity:{x:0,y:0},image:this.item.image},t),t.context.globalAlpha=1)}},yt=xt;"use strict";var St={audio:["test"],images:["test","clown","submarine","octopus_0","octopus_1","octopus_2","football","treasure","seahorse","bubbles","lost","won","background","air"]},m,r;H.once("load",()=>{var i=document.getElementById("main");r=m=new tt(kt,i,[at,ct(St),et,rt,lt]),r.mouse=new nt({game:r}),m.resources.status.on("changed",()=>{m.graphics.context.clearRect(0,0,r.width,r.height),m.graphics.context.fillStyle="black",m.graphics.context.font="arial",m.graphics.fillCenteredText(`Preloading ${m.resources.status.ready} / ${m.resources.status.total}...`,400,300)})});function kt(i){i&&console.error(i);var t=m.resources.images,e=m.resources.audio;m.objects.lists.collidable=m.objects.createIndexList("collidable"),m.objects.lists.start=m.objects.createIndexList("start"),m.objects.lists.shadow=m.objects.createIndexList("shadow"),m.objects.lists.background=m.objects.createIndexList("background"),m.objects.lists.foreground=m.objects.createIndexList("foreground"),m.objects.lists.grounded=m.objects.createIndexList("grounded"),m.objects.lists.export=m.objects.createIndexList("export"),m.objects.lists.end=m.objects.createIndexList("end"),m.objects.lists.editorVisible=m.objects.createIndexList("editorVisible");function s(c){return c[c.length*Math.random()|0]}r.autoRefresh=new vt({game:r}),r.camera=new ft({game:r}),r.touchSystem=new ut({game:r,debug:!1}),r.levelSystem=new st({game:r}),r.chains.draw.push((c,o)=>{c.save(),c.context.translate(-1024,0),c.context.scale(5,5),c.context.fillStyle="#0fb0fe",c.context.fillRect(0,0,2048,9999999),r.backgroundPattern||(r.backgroundPattern=c.context.createPattern(t.background,"repeat")),c.context.fillStyle=r.backgroundPattern,c.context.fillRect(0,0,2048,9999999),r.bubblesPattern||(r.bubblesPattern=c.context.createPattern(t.bubbles,"repeat")),c.context.scale(.2,.2),c.save(),c.context.translate(0,r.time*-200%t.bubbles.height),c.context.fillStyle=r.bubblesPattern,c.context.fillRect(0,0,2048,9999999),c.restore(),c.drawCenteredImage(t.air,1024,-t.air.height/2+64),c.restore(),o(c)}),function(){r.chains.draw.push((c,o)=>{for(let a of r.objects.lists.background)a.drawBackground(c);for(let a of r.objects.lists.foreground)a.drawForeground(c);o(c)})}();class n{constructor({x:o,y:a}){this.position=new g(o,a)}}class l extends n{constructor(){super(...arguments);h(this,"start",!0)}drawForeground(o){o.drawCenteredImage(t.test,this.position.x,this.position.y)}}class f extends n{constructor({x:o,y:a}){super({x:o,y:a});h(this,"updatable",!0);h(this,"touchable",!0);h(this,"foreground",!0);h(this,"touchable",!0);h(this,"targetPosition",new g(0,0));h(this,"lifeTime",0);h(this,"sinkRate",200);h(this,"maxSpeed",500);h(this,"touchRadius",150);h(this,"slowStartTime",5);this.image=t.submarine,this.velocity=new g(0,0),this.flipped=!1}drawForeground(o){o.save(),o.context.translate(this.position.x,this.position.y),o.context.scale(this.flipped?-1:1,1),o.drawCenteredImage(this.image,0,0),o.restore()}update(o){this.lifeTime+=o;let a=Math.min(this.lifeTime/this.slowStartTime,1),w=this.targetPosition.x-this.position.x,b=Math.sign(w),O=Math.abs(w)>50,W=O?this.maxSpeed:0;this.flipped=O?b<0:this.flipped,this.velocity.x=this.velocity.x*.9+b*W*.1,this.velocity.y=this.sinkRate,this.position.addV(this.velocity.clone().multiply(o*a))}touch(o){o instanceof u&&r.changeState(new wt)}}function d(c){return c*(Math.PI/180)}class x{constructor(o,a,w,b){this.top=o,this.right=a,this.bottom=w,this.left=b,o>0&&console.error("top should be negative of zero"),b>0&&console.error("top should be negative of zero"),w<0&&console.error("top should be positive of zero"),a<0&&console.error("right should be positive of zero")}}class u extends n{constructor({x:o,y:a,angle:w,speed:b,image:$=t.fish,top:O=0,right:W=500,bottom:bt=0,left:Pt=-500}){super({x:o,y:a});h(this,"updatable",!0);h(this,"foreground",!0);h(this,"touchable",!0);h(this,"touchRadius",100);this.startPosition=new g(o,a),this.relativePosition=new g(0,0),this.image=$,this.size={width:1,height:1},this.boundaries=new x(O,W,bt,Pt),this.velocity=this.angleAndSpeedtoVector(w,b)}angleAndSpeedtoVector(o,a){let w=Math.sin(d(o))*a,b=Math.cos(d(o))*a;return new g(b,w)}update(o){let a=this.velocity.clone();this.relativePosition.addV(a.multiply(o)),(this.relativePosition.x>this.boundaries.right||this.relativePosition.x<this.boundaries.left)&&(this.velocity.x*=-1),this.position=this.startPosition.clone().addV(this.relativePosition)}drawForeground(o){o.save(),o.context.translate(this.position.x,this.position.y),o.context.scale(this.velocity.x<0?1:-1,1),o.drawCenteredImage(this.image,0,0),o.restore()}}class v extends u{constructor(o){super({image:t.clown,...o})}}class S extends u{constructor({x:o,y:a}){super({x:o,y:a,image:t.football,angle:45,speed:200,top:-100,bottom:100,left:800,right:-800})}update(o){let a=this.velocity.clone();this.relativePosition.addV(a.multiply(o)),(this.relativePosition.x>this.boundaries.right||this.relativePosition.x<this.boundaries.left)&&(this.velocity.x*=-1),(this.relativePosition.y<this.boundaries.top||this.relativePosition.y>this.boundaries.bottom)&&(this.velocity.y*=-1),this.position=this.startPosition.clone().addV(this.relativePosition)}drawForeground(o){o.save(),o.context.translate(this.position.x,this.position.y),o.context.scale(this.velocity.x<0?1:-1,1),o.context.rotate(this.velocity.x<0?this.velocity.angle()+Math.PI:this.velocity.angle()*-1),o.drawCenteredImage(this.image,0,0),o.restore()}}class j extends u{constructor({x:o,y:a}){super({x:o,y:a,image:t.octopus_0,angle:15,speed:300,top:-200,left:200,bottom:200,right:-200});this.frame=0}update(o){this.frame+=o*2,this.image=t[`octopus_${Math.round(this.frame)%3}`];let a=this.velocity.clone();this.relativePosition.addV(a.multiply(o)),(this.relativePosition.x>this.boundaries.right||this.relativePosition.x<this.boundaries.left)&&(this.velocity.x*=-1),(this.relativePosition.y<this.boundaries.top||this.relativePosition.y>this.boundaries.bottom)&&(this.velocity.y*=-1),this.position=this.startPosition.clone().addV(this.relativePosition)}drawForeground(o){o.save(),o.context.translate(this.position.x,this.position.y),o.context.scale(this.velocity.x<0?-1:1,1),o.drawCenteredImage(this.image,0,0),o.restore()}}class y extends u{constructor({x:o,y:a}){super({x:o,y:a,image:t.seahorse,angle:0,speed:200,top:0,right:1400,bottom:0,left:-1400})}update(o){let a=this.velocity.clone();this.relativePosition.addV(a.multiply(o)),this.relativePosition.x>this.boundaries.right&&(this.relativePosition.x=this.boundaries.left),this.position=this.startPosition.clone().addV(this.relativePosition)}drawForeground(o){o.save(),o.context.translate(this.position.x,this.position.y),o.context.scale(1,1),o.drawCenteredImage(this.image,0,0),o.restore()}}class T extends n{constructor(...o){super(...o);h(this,"touchable",!0);h(this,"updatable",!0);h(this,"foreground",!0);h(this,"touchRadius",100);h(this,"patrolInterval",4);h(this,"waveInterval",2);h(this,"phase",300);h(this,"speed",300);this.velocity=new g(0,0),this.lifetime=0,this.direction=1}update(o){this.lifetime+=o,this.direction=(Math.floor(this.lifetime/this.patrolInterval)%2-.5)*2,this.velocity=g.xaxis.clone().rotate(Math.sin(this.lifetime*(Math.PI*2)/this.waveInterval)),this.velocity.x*=this.speed*this.direction,this.velocity.y*=this.phase*this.direction,this.position.addV(this.velocity.clone().multiply(o))}drawForeground(o){o.save(),o.context.translate(this.position.x,this.position.y),o.context.rotate(this.velocity.angle()),o.context.scale(this.direction,this.direction),o.drawCenteredImage(t.clown,0,0),o.restore()}}class P extends n{constructor({x:o,y:a}){super({x:o,y:a});h(this,"end",!0);h(this,"background",!0);this.image=t.treasure}get bottom(){return this.position.y+this.image.height*.5}drawBackground(o){o.drawCenteredImage(this.image,this.position.x,this.position.y)}}function k(c,o){c.save();let a=r.width/o.width,w=r.height/o.height,b=Math.min(a,w);c.context.scale(b,b),c.drawCenteredImage(o,r.width/2/b,r.height/2/b),c.restore()}class M{constructor({game:o}){this.game=o,this.update=this.update.bind(this),this.keydown=this.keydown.bind(this),this.levelchanged=this.levelchanged.bind(this)}enable(){this.game.camera.reset(),this.game.chains.update.push(this.update),this.game.on("keydown",this.keydown),this.game.on("levelchanged",this.levelchanged);let o=r.objects.lists.start.first;this.start!==o&&this.spawnPlayer(o)}disable(){this.game.chains.update.remove(this.update),this.game.removeListener("keydown",this.keydown),this.game.removeListener("levelchanged",this.levelchanged)}levelchanged(){let o=r.objects.lists.start.first;this.spawnPlayer(o)}spawnPlayer(o){this.start=o;let a=new f({x:o.position.x,y:o.position.y});this.player=a,r.objects.add(a)}keydown(o){if(o==="r"){this.game.levelSystem.restartLevel();return}else if(o==="n"){this.game.levelSystem.nextLevel();return}else if(o==="m"){this.game.levelSystem.changeLevel(D());return}else o==="e"&&this.game.changeState(new yt({game:r,gameplayState:this,items:[l,v]}));let a=new g((o==="right"?1:0)-(o==="left"?1:0),(o==="down"?1:0)-(o==="up"?1:0));this.player.movement=a}update(o){this.game.camera.screenToWorld(this.game.mouse,this.player.targetPosition);let a=[...this.game.objects.lists.end][0];this.game.camera.y=Math.min(this.player.position.y,a.bottom-this.game.height*.5/this.game.camera.getPixelsPerMeter()),this.player.position.y>a.position.y&&this.game.changeState(new gt)}}function D(){return{name:"Level 1",objects:[new l({x:0,y:0}),new v({x:300,y:800,angle:180,speed:300,top:0,right:200,bottom:0,left:-500}),new v({x:80,y:3e3,angle:180,speed:300,top:0,right:500,bottom:0,left:-500}),new v({x:160,y:2800,angle:180,speed:320,top:0,right:500,bottom:0,left:-500}),new v({x:80,y:2600,angle:180,speed:300,top:0,right:500,bottom:0,left:-500}),new v({x:-20,y:4600,angle:0,speed:300,top:0,right:500,bottom:0,left:-500}),new v({x:60,y:4400,angle:0,speed:320,top:0,right:500,bottom:0,left:-500}),new v({x:-20,y:4200,angle:0,speed:300,top:0,right:500,bottom:0,left:-500}),new P({x:0,y:6e3})],clone:D,nextLevel:G}}function G(){return{name:"Level 2",objects:[new l({x:0,y:0}),new T({x:500,y:1e3}),new v(300,1e3),new j(60,2e3),new S(80,3e3),new y(200,4e3),new P({x:0,y:4500})],clone:G,nextLevel:null}}class gt{constructor(){this.draw=this.draw.bind(this),this.mousedown=this.mousedown.bind(this),this.update=this.update.bind(this)}enable(){m.chains.draw.unshift(this.draw),m.chains.update.unshift(this.update),m.on("mousedown",this.mousedown)}disable(){m.chains.draw.remove(this.draw),m.chains.update.remove(this.update),m.removeListener("mousedown",this.mousedown)}draw(o,a){a(o),o.save(),o.context.translate(r.width*.5,r.height*.5);let w=r.camera.getPixelsPerMeter();o.context.scale(w,w),o.drawCenteredImage(t.won,0,0),o.restore()}mousedown(){r.levelSystem.nextLevel(),r.changeState(new M({game:r}))}update(o,a){}}class wt{constructor(){this.draw=this.draw.bind(this),this.mousedown=this.mousedown.bind(this),this.update=this.update.bind(this)}enable(){m.chains.draw.unshift(this.draw),m.chains.update.unshift(this.update),m.on("mousedown",this.mousedown)}disable(){m.chains.draw.remove(this.draw),m.chains.update.remove(this.update),m.removeListener("mousedown",this.mousedown)}draw(o,a){a(o),o.save(),o.context.translate(r.width*.5,r.height*.5);let w=r.camera.getPixelsPerMeter();o.context.scale(w,w),o.drawCenteredImage(t.lost,0,0),o.restore()}mousedown(){r.levelSystem.restartLevel(),r.changeState(new M({game:r}))}update(o,a){}}r.levelSystem.changeLevel(D()),r.objects.handlePending(),r.changeState(new M({game:r})),r.start(),window.game=r}})();
//# sourceMappingURL=main.js.map
